<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gravitas+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gravitas+One&family=Libre+Barcode+EAN13+Text&family=Questrial&display=swap" rel="stylesheet">
    <link href="" rel="stylesheet">
    <style>
      /* --- 共通スタイル: 画面全体をFlexbox化 --- */
      html, body {
        height: 100%; /* 高さいっぱい確保 */
        margin: 0; padding: 0;
      }
      body {
        font-family: "Hiragino Kaku Gothic ProN", sans-serif; /* フォント指定を少し安全に修正 */
        font-size: 13px; font-weight: 600; letter-spacing: 3.95px;
        /* line-height: 118.46px; ←これが全体にかかると崩れるので削除または調整 */
        background-color: #D8DEEC; color: rgba(78, 78, 78, 1);

        /* ▼縦並びFlexにする設定▼ */
        display: flex;
        flex-direction: column;
      }

      .container {
        max-width: 600px;
        width: 100%;
        margin: 0 auto; /* 上下のmarginは削除し、横だけauto */

        /* ▼コンテナも高さいっぱいに広げる▼ */
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px; /* 全体の余白 */
        box-sizing: border-box;
      }

      /* --- ボタン（兼リンク）のスタイル --- */
      .action-btn {
        font-family: "Gravitas One"; font-weight: 400; letter-spacing: 0px;
        display: block; width: 100%; height: 60px; padding: 0 10px; font-size: 14px;
        color: white; border: none; border-radius: 50px; cursor: pointer;
        transition: opacity 0.2s; text-align: center; text-decoration: none; box-sizing: border-box;

        /* 文字の上下中央揃え（aタグ用） */
        line-height: 60px;

        /* ▼▼▼ これが魔法の記述（一番下に押し下げる） ▼▼▼ */
        margin-top: auto;
      }
      .primary { background-color: rgba(0, 133, 157, 1); }
      .success { background-color: rgba(0, 133, 157, 1); }
      button.action-btn:active, a.action-btn:active { opacity: 0.8; }
      button:disabled { background-color: #ccc; cursor: not-allowed; }

      /* --- 画面エリアごとのFlex設定 --- */
      /* JavaScriptで display: flex に切り替えられるように準備 */
      #login-screen, #quiz-screen {
        flex: 1; /* 親(container)の中でいっぱいに広がる */
        flex-direction: column;
        /* display: none; ← 初期状態は none ですが、JSで flex になります */
      }

      /* クイズフォームも縦に広げる */
      #quiz-content-area, form#quizForm {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      /* --- ログイン画面用 --- */
      #login-screen { text-align: center; }
      .select-group { text-align: left; margin-bottom: 10px; } /* 余白調整 */
      .select-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
      select { width: 100%; height: 60px; padding: 15px; font-size: 13px; border: 0; border-radius: 10px; background-color: white; appearance: none; -webkit-appearance: none; font-family: "Questrial"; }
      select:disabled { background-color: #f9f9f9; color: #aaa; }
      select:invalid { color: #aaa; }
      select option { color: rgba(78, 78, 78, 1); }

      .select-wrapper { position: relative; width: 100%; }
      .select-wrapper::after {
        content: ''; position: absolute; top: 50%; right: 25px; transform: translateY(-50%);
        width: 0; height: 0;
        border-left: 6px solid transparent; border-right: 6px solid transparent;
        border-top: 8px solid rgba(0, 133, 157, 1); pointer-events: none;
      }

      /* --- クイズ画面用パーツ --- */
      .user-bar { background: #333; color: white; padding: 10px 15px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; margin-bottom: 20px; }
      .logout-btn { background: #555; border: none; color: #ccc; font-size: 12px; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
      #timer-box { text-align: center; margin-bottom: 20px; padding: 10px; }
      #time-display { font-size: 17px; font-weight: 5000; color: rgba(231, 0, 11, 1); }
      .question-box { margin: 10px 0 60px; }
      .question-box .question-text { position: relative; text-align: center; background-color:#ffffff; border: solid 1px rgba(0, 133, 157, 1); border-radius: 8px; padding: 55px 30px; margin-bottom: 15px; }
      .question-box.is-time-up .question-text::after {
        content: "時間切れ"; /* 表示したい文字 */

        /* 完全に上にかぶせる設定 */
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;

        /* 見た目の調整 */
        background-color: rgba(237, 237, 237, 0.8); /* 少し透けたグレー背景 */
        border-radius: 8px;
        font-size: 21px;
        font-weight: 5000;
        letter-spacing: 3.95px;

        /* 中央寄せ */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
      }
      .choices label { text-align: center; display: block; padding: 15px; background: white; margin-bottom: 10px; border-radius: 8px; border: 0; cursor: pointer; }
      .choices label:hover { background-color: rgba(0, 133, 157, 1); color: white; }
      input[type="radio"] { display: none; }
      /* ラジオボタンが無効化されている時、ラベルのカーソルを「禁止」マークにする */
      .choices label:has(input:disabled) {
        cursor: not-allowed;
        background-color: rgba(234, 234, 234, 1);
        color: rgba(192, 192, 192, 1)
      }

      /* 古いブラウザやスマホの一部で :has が効かない場合の予備（input自体への指定） */
      input[type="radio"]:disabled {
        cursor: not-allowed;
      }

      /* 無効化時はホバーしても色を変えない */
      .choices label:has(input:disabled):hover {
        background-color: rgba(234, 234, 234, 1);
        color: rgba(192, 192, 192, 1)
      }

      .result-box { text-align: center; padding: 25px; border-radius: 10px; margin-bottom: 25px; border: 3px solid transparent;}
      .result-correct { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
      .result-wrong { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
      .explanation-text { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px; border-left: 5px solid #007bff; }

      /* 背景ドット */
      .background-dot { position: fixed; border-radius: 50%; z-index: -3; }
      .pink-dot { background-color: rgba(255, 228, 228, 0.5); }
      .white-dot { background-color: rgba(255, 255, 255, 0.5); }
      .yellow-dot { background-color: rgba(255, 254, 229, 0.5); }
      .blue-dot { background-color: rgba(225, 236, 247, 1);}

      /* 回答済みエリア */
      #already-answered-box {
        display: none; text-align: center;
        flex: 1; flex-direction: column; /* ここもFlexにしてボタンを下へ */
      }

      /* 共通 */
      * { -webkit-tap-highlight-color: transparent; outline: none; }
      .fancy-font, h1, p { user-select: none; -webkit-user-select: none; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="background-dot pink-dot" style="width: 48px; height: 48px; top: 20px; left: 336px;"></div>
      <div class="background-dot blue-dot" style="width: 68px; height: 68px; top: 44px; filter: blur(7px);"></div>
      <div class="background-dot white-dot" style="width: 13px; height: 13px; top: 72px; left: 125px;"></div>
      <div class="background-dot white-dot" style="width: 13px; height: 13px; top: 85px; left: 305px;"></div>
      <div class="background-dot white-dot" style="width: 13px; height: 13px; top: 129px; left: 15px;"></div>
      <div class="background-dot yellow-dot" style="width: 110px; height: 110px; top: 92px; left: 150px; filter: blur(2px);"></div>
      <div class="background-dot pink-dot" style="width: 108px; height: 108px; top: 529px; left: 142px;"></div>
      <div class="background-dot pink-dot" style="width: 28px; height: 28px; top: 180px; left: 3px;"></div>
      <div class="background-dot white-dot" style="width: 190px; height: 190px; top: 142px; left: 205px; filter: blur(7px);"></div>
      <div class="background-dot yellow-dot" style="width: 18px; height: 18px; top: 247px; left: 36px; filter: blur(2px);"></div>
      <div class="background-dot white-dot" style="width: 13px; height: 13px; top: 313px; left: 18px;"></div>
      <div class="background-dot blue-dot" style="width: 190px; height: 190px; top: 422px; left: -9px; filter: blur(7px);"></div>
      <div class="background-dot pink-dot" style="width: 108px; height: 108px; top: 529px; left: 142px; opacity: 0.4; filter: blur(14px);"></div>
      <div class="background-dot yellow-dot" style="width: 40px; height: 40px; top: 510px; left: 350px; filter: blur(2px);"></div>
      <div class="background-dot white-dot" style="width: 13px; height: 13px; top: 679px; left: 15px;"></div>
      <div class="background-dot yellow-dot" style="width: 68px; height: 68px; top: 709px; left: 3px; filter: blur(7px);"></div>
      <div class="background-dot blue-dot" style="width: 92px; height: 92px; top: 672px; left: 97px; filter: blur(7px);"></div>
      <div class="background-dot white-dot" style="width: 13px; height: 13px; top: 659px; left: 253px;"></div>
      <div class="background-dot yellow-dot" style="width: 18px; height: 18px; top: 700px; left: 336px; filter: blur(2px);"></div>
      <div id="login-screen" style="display: none;">
        <img src="https://drive.google.com/thumbnail?id=1vQKnzvrbqm1SjDbLVZ3s3vYwGmotWXqJ&sz=w290" style="margin: 105px 0 25px 0;">

        <div class="select-group" id="teamSelectArea">
          <div class="select-wrapper">
            <select id="teamSelect" onchange="onTeamChanged()" required>
              <option value="" disabled selected hidden>Select team</option>
            </select>
          </div>
        </div>

        <div id="fixedTeamArea" style="display:none; text-align:left; margin: 0 0 15px 5px;">
          <div id="fixedTeamName" style="font-size:16px; font-weight:bold;"></div>
        </div>
        <div class="select-group">
          <div class="select-wrapper">
            <select id="memberSelect" required>
              <option value="" disabled selected hidden>Your name</option>
            </select>
          </div>
        </div>
        <button onclick="registerUser()" class="action-btn primary">Let's play!</button>
      </div>

      <div id="quiz-screen">
        <? if (isStandbyMode) { ?>
          <div style="text-align:center;">
            <img src="https://drive.google.com/thumbnail?id=1FCZsMrutJZTkyItH_tF8x1ZBfQJHLEPj&sz=w160" style="margin: 55px 0 20px 0;">
            <p style="font-size:15px; line-height:2.0;">エントリーが完了しました。<br>クイズ開始までお待ちください！</p>
          </div>
          <div style="text-align:center; display: flex; flex-direction: column; flex: 1;">
            <button onclick="reloadPage()" class="action-btn primary">Let's play!</button>
          </div>
        <? } else if (isWaitingMode) { ?>
          <div style="text-align:center;">
            <img src="https://drive.google.com/thumbnail?id=1FCZsMrutJZTkyItH_tF8x1ZBfQJHLEPj&sz=w160" style="margin: 55px 0 20px 0;">
            <p style="margin-top:25px; font-size:13px;">
              次の問題までお待ちください！
            </p>
            <p style="margin-top:10px; font-size:16px;">
              司会者が「次の問題へ」といったら<br>下のボタンを押してください
            </p>
          </div>
          <div style="text-align:center; display: flex; flex-direction: column; flex: 1;">
            <button onclick="reloadPage()" class="action-btn primary">GO GO!</button>
          </div>
        <? } else { ?>
          <div id="already-answered-box">
            <div style="text-align:center;">
              <img src="https://drive.google.com/thumbnail?id=1ijFj-yFTOF3VousVora0HK_rAoSFEJrk&sz=w160" style="margin: 55px 0 20px 0;">
            </div>

            <p style="margin-top:25px; font-size:13px;">
              正解発表までお待ちください
            </p>
            <p style="margin-top:10px; font-size:16px;">
              司会者が「次の問題へ」といったら<br>下のボタンを押してください
            </p>
            <div style="text-align:center; display: flex; flex-direction: column; flex: 1;">
              <button onclick="reloadPage()" class="action-btn primary">GO GO!</button>
            </div>
          </div>

          <div id="quiz-content-area">
            <div style="text-align:center;">
              <img src="https://drive.google.com/thumbnail?id=1Fp4hgmxGP7hFhvfS9rTfn6HZjgfAQPnM&sz=w160" style="margin: 55px 0 0 0;">
            </div>

            <div id="timer-box">残り<span id="time-display">--</span>秒</div>

            <form id="quizForm" method="post" action="<?= ScriptApp.getService().getUrl() ?>" onsubmit="return handleFormSubmit();">
              <div class="question-box">
                <div class="question-text"><?= question.text ?></div>
                <input type="hidden" name="questionId" value="<?= question.id ?>">
                <input type="hidden" id="limitTimeSeconds" name="limitTimeSeconds" value="<?= question.timeLimit ?>">
                <input type="hidden" id="elapsedTimeSeconds" name="elapsedTimeSeconds" value="0">
                <input type="hidden" id="groupName" name="groupName">
                <input type="hidden" id="memberName" name="memberName">
                <div class="choices">
                  <label><input type="radio" name="userAnswer" value="A" required><?= question.choiceA ?></label>
                  <label><input type="radio" name="userAnswer" value="B" required><?= question.choiceB ?></label>
                  <label><input type="radio" name="userAnswer" value="C" required><?= question.choiceC ?></label>
                  <label><input type="radio" name="userAnswer" value="D" required><?= question.choiceD ?></label>
                </div>
              </div>
              <button type="submit" id="submitBtn" class="action-btn primary">Enter!</button>
            </form>
          </div>

          <script>
            // キー定義
            var originalTimeLimit = <?= question.timeLimit || 300 ?>;
            var qId = "<?= question.id ?>";
            var timerKey = "quiz_start_time_" + qId;
            var answeredKey = "has_answered_" + qId; // ★回答済みフラグのキー

            var startTime;
            var timerInterval;

            function initQuestion() {
              // ▼▼▼ 回答済みチェック ▼▼▼
              if (localStorage.getItem(answeredKey)) {
                // 回答済みならフォームを消して、完了メッセージを出す
                document.getElementById("quiz-content-area").style.display = "none";
                document.getElementById("already-answered-box").style.display = "flex";
                return; // タイマーも起動しない
              }

              // タイマー初期化
              var savedStart = localStorage.getItem(timerKey);
              if (savedStart) {
                startTime = new Date(parseInt(savedStart));
              } else {
                startTime = new Date();
                localStorage.setItem(timerKey, startTime.getTime());
              }
              updateTimer();
              timerInterval = setInterval(updateTimer, 1000);
            }

            function updateTimer() {
              var now = new Date();
              var elapsedSec = Math.floor((now - startTime) / 1000);
              var timeLeft = originalTimeLimit - elapsedSec;

              if (timeLeft <= 0) {
                document.getElementById("time-display").innerText = "0";
                clearInterval(timerInterval);
                timeUp();
              } else {
                document.getElementById("time-display").innerText = timeLeft;
              }
            }

            function timeUp() {
              var qBox = document.querySelector(".question-box");
              if (qBox) {
                qBox.classList.add("is-time-up");
              }
              var btn = document.getElementById("submitBtn");
              if(btn) {
                // 1. ボタンを押せる状態に戻す（さっきまでdisabledにしていた場合は解除）
                btn.disabled = false;

                // 2. 文言を「Go Next!」に変更
                btn.innerText = "Go Next!";

                // 3. ボタンの種類を「送信(submit)」から「ただのボタン(button)」に変える
                // これをしないと、押した瞬間にフォーム送信しようとしてエラーになります
                btn.setAttribute("type", "button");

                // 4. クリックしたらリロード（reloadPage）するように変更
                btn.onclick = reloadPage;
              }

              var radios = document.getElementsByName("userAnswer");
              for (var i = 0; i < radios.length; i++) {
                radios[i].disabled = true;
              }
            }

            function handleFormSubmit() {
              var userInfo = localStorage.getItem("quiz_user_info");
              if (!userInfo) { alert("ログイン情報がありません"); location.reload(); return false; }

              var myChoice = document.querySelector('input[name="userAnswer"]:checked').value;

              // 保存処理
              localStorage.setItem("last_answer_" + qId, myChoice);
              localStorage.setItem(answeredKey, "true"); // ★ここで「回答済み」にする

              var parts = userInfo.split("__");
              document.getElementById("groupName").value = parts[0];
              document.getElementById("memberName").value = parts[1];

              var now = new Date();
              var actualElapsed = Math.floor((now - startTime) / 1000);
              document.getElementById("elapsedTimeSeconds").value = actualElapsed;

              var btn = document.getElementById("submitBtn");
              btn.disabled = true; btn.innerText = "Sending...";
              return true;
            }
          </script>
        <? } ?>
      </div>
    </div>

    <script>
      var allMembers = [];
      try {
        var rawData = '<?= JSON.stringify(members) ?>';
        if (rawData && rawData !== 'undefined') allMembers = JSON.parse(rawData);
      } catch(e) {}
      var urlTeam = "<?= preSelectedTeam ?>";

      window.onload = function() {
        initLoginScreen();
        checkLoginStatus();
        if (urlTeam) applyUrlTeam(urlTeam);
      };
      // ... (以下、前回と同じログイン関係の関数) ...
      function initLoginScreen() {
        if (localStorage.getItem("quiz_user_info")) return; // すでにログイン済みなら処理しない

        document.getElementById('login-screen').style.display = "flex";
        var teamSelect = document.getElementById("teamSelect");
        var uniqueTeams = [];
        if (!allMembers || allMembers.length === 0) return;
        for(var i=0; i<allMembers.length; i++) {
          var t = allMembers[i][0];
          if(t && uniqueTeams.indexOf(t) === -1) uniqueTeams.push(t);
        }
        for(var j=0; j<uniqueTeams.length; j++) {
          var op = document.createElement("option");
          op.text = uniqueTeams[j]; op.value = uniqueTeams[j];
          teamSelect.appendChild(op);
        }
      }
      function applyUrlTeam(tName) {
        document.getElementById("teamSelectArea").style.display = "none";
        document.getElementById("fixedTeamArea").style.display = "block";
        document.getElementById("fixedTeamName").innerText = `${tName}チーム`;
        document.getElementById("teamSelect").value = tName;
        onTeamChanged();
      }
      function onTeamChanged() {
        var tVal = document.getElementById("teamSelect").value;
        var mSelect = document.getElementById("memberSelect");
        mSelect.innerHTML = '<option value="" disabled selected>Your name</option>';
        mSelect.disabled = false;
        for(var i=0; i<allMembers.length; i++) {
          if(allMembers[i][0] === tVal) {
            var op = document.createElement("option");
            op.text = allMembers[i][1]; op.value = allMembers[i][0] + "__" + allMembers[i][1];
            mSelect.appendChild(op);
          }
        }
      }
      function checkLoginStatus() {
        var u = localStorage.getItem("quiz_user_info");
        if (u) {
          document.getElementById("login-screen").style.display = "none";
          document.getElementById("quiz-screen").style.display = "flex";
          var p = u.split("__");
          if (typeof initExplanation === "function") initExplanation();
          if (typeof initQuestion === "function") initQuestion();
        } else {
          document.getElementById("login-screen").style.display = "flex";
          document.getElementById("quiz-screen").style.display = "none";
        }
      }
      function registerUser() {
        var v = document.getElementById("memberSelect").value;
        if (!v) { alert("チームと名前を選択してください"); return; }
        localStorage.setItem("quiz_user_info", v);
        checkLoginStatus();
      }
      function logoutUser() {
        if(confirm("参加者を変更しますか？")) {
          localStorage.removeItem("quiz_user_info");
          location.reload();
        }
      }
      function reloadPage() {
        window.open("<?= ScriptApp.getService().getUrl() ?>", "_top");
      }
    </script>
  </body>
</html>
